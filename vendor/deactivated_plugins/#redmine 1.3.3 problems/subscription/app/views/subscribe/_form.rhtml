<% if User.current.allowed_to?(:subscribe_to_project, @project) %>

  <% unless defined? @subscriber %>
    <% @subscriber = ProjectSubscriber.find_by_project_id_and_user_id(@project.id, User.current.id) %>
  <% end %>
  <% unless defined? @count %>
    <% @count = ProjectSubscriber.count(:conditions => { :project_id => @project }) %>
  <% end %>

  <div id="subscribe">

    <div class="contextual">
      <%= link_to_remote(@subscriber && !@subscriber.new_record? ? l(:button_update) : l(:label_subscribe),
                         :url => { :controller => 'subscriptions',
                                   :action     => 'subscription',
                                   :id         => @project,
                                   :resource   => defined?(resource) ? resource : nil }) %>
    </div>

    <h3>
      <%= l(:label_subscription) %>
      <% if User.current.allowed_to?(:view_number_of_subscribers, @project) && @count > 0 %>
        (<%= @count %>)
      <% end %>
    </h3>

    <% if (params[:controller] == 'projects' || params[:controller] == 'subscriptions') && (!@subscriber || @subscriber.new_record? || request.post?) %>

      <% if @message %>

        <p id="subscribe-message" class="nodata"><%= h(@message) %></p>

      <% else %>

        <% remote_form_for(:subscriber, :url => { :controller => 'subscriptions',
                                                  :action => 'subscribe',
                                                  :id => @project },
                                        :method => :post,
                                        :html => { :id => 'subscription-form' }) do %>
        <p>
          <% if @project.module_enabled?('news') && (Setting.notified_events.include?('news_added') || Setting.notified_events.include?('news_comment_added')) %>
            <label><%= check_box_tag('subscribed_to[news]', 1, @subscriber ? @subscriber.subscribed_to?(:news) : true) %> <%= l(:label_news) %></label><br />
          <% end %>
          <% if Setting.notified_events.include?('version_closed') %>
            <label><%= check_box_tag('subscribed_to[releases]', 1, @subscriber ? @subscriber.subscribed_to?(:releases) : true) %> <%= l(:label_releases) %></label><br />
          <% end %>
          <% if @project.module_enabled?('files') && Setting.notified_events.include?('file_added') %>
            <label><%= check_box_tag('subscribed_to[files]', 1, @subscriber ? @subscriber.subscribed_to?(:files) : true) %> <%= l(:label_files) %></label><br />
          <% end %>
          <% if @project.module_enabled?('wiki') && Setting.notified_events.include?('wiki_content_added') %>
            <label><%= check_box_tag('subscribed_to[wiki_pages]', 1, @subscriber ? @subscriber.subscribed_to?(:wiki_pages) : false) %> <%= l(:label_wiki_pages) %></label><br />
          <% end %>
          <% if @project.module_enabled?('repository') && Setting.notified_events.include?('changeset_added') %>
            <label><%= check_box_tag('subscribed_to[repository]', 1, @subscriber ? @subscriber.subscribed_to?(:repository) : false) %> <%= l(:label_repository_commits) %></label><br />
          <% end %>
          <% if @project.module_enabled?('issue_tracking') && Setting.notified_events.include?('issue_added') %>
            <label><%= check_box_tag('subscribed_to[new_issues]', 1, @subscriber ? @subscriber.subscribed_to?(:new_issues) : false) %> <%= l(:label_issues_new) %></label><br />
          <% end %>
          <% if @project.module_enabled?('issue_tracking') && Setting.notified_events.include?('issue_updated') %>
            <label><%= check_box_tag('subscribed_to[closed_issues]', 1, @subscriber ? @subscriber.subscribed_to?(:closed_issues) : false) %> <%= l(:label_issues_closed) %></label><br />
          <% end %>
          <% if @project.module_enabled?('boards') && Setting.notified_events.include?('board_added') %>
            <label><%= check_box_tag('subscribed_to[forums]', 1, @subscriber ? @subscriber.subscribed_to?(:forums) : false) %> <%= l(:label_forums_new) %></label><br />
          <% end %>
        </p>
        <p>
          <%= submit_tag(@subscriber && !@subscriber.new_record? ? l(:button_update) : l(:label_subscribe), :class => 'small') %>
          <%= toggle_link(l(:button_cancel), 'subscription-form') %>
        </p>
        <% end %>

      <% end %>

    <% end %>

  </div>

<% end %>
